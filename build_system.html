

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Build system &mdash; Pigweed</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Frequently Asked Questions" href="docs/faq.html" />
    <link rel="prev" title="stm32f429i-disc1" href="targets/stm32f429i-disc1/target_docs.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Pigweed
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pigweed.googlesource.com/pigweed/pigweed/+/refs/heads/master">Source Code</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pigweed-review.googlesource.com">Code Reviews</a></li>
<li class="toctree-l1"><a class="reference external" href="https://groups.google.com/forum/#!forum/pigweed">Mailing List</a></li>
<li class="toctree-l1"><a class="reference external" href="https://discord.gg/M9NSeTA">Chat Room</a></li>
<li class="toctree-l1"><a class="reference external" href="https://bugs.chromium.org/p/pigweed/issues/list">Issue Tracker</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="CODE_OF_CONDUCT.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs/embedded_cpp_guide.html">Embedded C++ Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs/style_guide.html">Code Style</a></li>
<li class="toctree-l1"><a class="reference internal" href="targets.html">Targets</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Build System</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-s-in-a-build-system">What’s in a build system?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#simple-toolchain-configuration">Simple toolchain configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multi-target-builds">Multi-target builds</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multi-language-support">Multi-language support</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-scripting">Custom scripting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#see-also">See also</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#python-packaging">Python packaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="#size-reporting">Size reporting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">See also</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#documentation">Documentation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">See also</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#unit-testing">Unit testing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#host-side-unit-tests">Host-side unit tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#device-side-unit-tests">Device-side unit tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">See also</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#bonus-pw-watch">Bonus: pw watch</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">See also</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#pigweed-s-build-systems">Pigweed’s build systems</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cmake">CMake</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bazel">Bazel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gn">GN</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#the-gn-build">The GN build</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#entrypoint-gn">Entrypoint: .gn</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-buildconfig-gn">Configuration: BUILDCONFIG.gn</a></li>
<li class="toctree-l3"><a class="reference internal" href="#top-level-gn-targets-build-gn">Top-level GN targets: //BUILD.gn</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#default-group">“default” group</a></li>
<li class="toctree-l4"><a class="reference internal" href="#upstream-gn-target-groups">Upstream GN target groups</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#other-build-files-build-gn">Other BUILD files: //**/BUILD.gn</a></li>
<li class="toctree-l3"><a class="reference internal" href="#project-configuration-build-overrides-pigweed-gni">Project configuration: //build_overrides/pigweed.gni</a></li>
<li class="toctree-l3"><a class="reference internal" href="#module-variables">Module variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gn-target-type-wrappers">GN target type wrappers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pigweed-targets">Pigweed targets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-dummy-toolchain">The dummy toolchain</a></li>
<li class="toctree-l3"><a class="reference internal" href="#upstream-development-examples">Upstream development examples</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#building-a-custom-executable-app-image">Building a custom executable/app image</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="docs/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs/module_structure.html">Module Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_guides.html">Module Guides</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Pigweed</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Build system</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="build-system">
<span id="chapter-build-system"></span><h1>Build system<a class="headerlink" href="#build-system" title="Permalink to this headline">¶</a></h1>
<p>Building software for embedded devices is a complex process. Projects often have
custom toolchains, target different hardware platforms, and require additional
configuration and post-processing of artifacts.</p>
<p>As a modern embedded framework, Pigweed’s goal is to collect these embedded use
cases into a powerful and flexible build system, then extend it with support for
modern software development practices.</p>
<div class="section" id="what-s-in-a-build-system">
<h2>What’s in a build system?<a class="headerlink" href="#what-s-in-a-build-system" title="Permalink to this headline">¶</a></h2>
<p>A quality build system provides a variety of features beyond compiling code.
Throughout our experience with embedded development, we’ve found several build
features to be especially useful, and designed Pigweed’s build system with them
in mind.</p>
<div class="section" id="simple-toolchain-configuration">
<h3>Simple toolchain configuration<a class="headerlink" href="#simple-toolchain-configuration" title="Permalink to this headline">¶</a></h3>
<p>Embedded projects often use custom build toolchains for their specific hardware.
Configuring these should be a simple process, both in their initial setup and
later adjustments.</p>
</div>
<div class="section" id="multi-target-builds">
<h3>Multi-target builds<a class="headerlink" href="#multi-target-builds" title="Permalink to this headline">¶</a></h3>
<p>Virtually every consumer product has firmware that targets different boards or
MCUs during development. While building for a single board is simple enough, the
complexity of supporting different targets ranges from changing compiler flags
to swapping out entire libraries of firmware and drivers. This is often done by
running multiple builds, configuring each one accordingly. In Pigweed, we’ve
designed our build system with first-class multi-target support in mind,
allowing any number of target configurations to be built simultaneously.</p>
</div>
<div class="section" id="multi-language-support">
<h3>Multi-language support<a class="headerlink" href="#multi-language-support" title="Permalink to this headline">¶</a></h3>
<p>Embedded projects are typically written in C, C++, and assembly. However, it is
possible to have firmware written in other languages, such as Rust.
Additionally, projects may have host-side tooling written in a wide variety of
languages. Having all of these build together proves to be a large time saver.</p>
</div>
<div class="section" id="custom-scripting">
<h3>Custom scripting<a class="headerlink" href="#custom-scripting" title="Permalink to this headline">¶</a></h3>
<p>Embedded projects often require post-processing of build artifacts; these may
include:</p>
<ul class="simple">
<li><p>Extracting ELF sections into a different container</p></li>
<li><p>Injecting metadata into firmware images</p></li>
<li><p>Image signing</p></li>
<li><p>Creating databases of symbols for debugging</p></li>
<li><p>Extracting string tokens into a database (for example, with
<a class="reference internal" href="pw_tokenizer/docs.html#chapter-pw-tokenizer"><span class="std std-ref">pw_tokenizer</span></a>)</p></li>
</ul>
<p>These are run as steps during a build, facilitated by the build system.</p>
<div class="section" id="see-also">
<h4>See also<a class="headerlink" href="#see-also" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference internal" href="pw_build/docs.html#pw-build-python-script"><span class="std std-ref">pw_python_script</span></a></p></li>
</ul>
</div>
</div>
<div class="section" id="python-packaging">
<h3>Python packaging<a class="headerlink" href="#python-packaging" title="Permalink to this headline">¶</a></h3>
<p>Python is a favorite scripting language of many development teams, and here at
Pigweed, we’re no exception. Much of Pigweed’s host-side tooling is written in
Python. While Python works great for local development, problems can arise when
scripts need to be packaged and distributed for vendors or factory teams. Having
proper support for packaging Python within a build system allows teams to focus
on writing code instead of worrying about distribution.</p>
</div>
<div class="section" id="size-reporting">
<h3>Size reporting<a class="headerlink" href="#size-reporting" title="Permalink to this headline">¶</a></h3>
<p>On embedded devices, memory is everything. Most projects have some sort of
custom tooling to determine how much flash and RAM space their firmware uses.
Being able to run size reports as part of a build ensures that they are always
up-to-date and allows space usage to be tracked over time.</p>
<div class="section" id="id1">
<h4>See also<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference internal" href="pw_bloat/docs.html#chapter-pw-bloat"><span class="std std-ref">pw_bloat</span></a></p></li>
</ul>
</div>
</div>
<div class="section" id="documentation">
<h3>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h3>
<p>An oft-neglected part of software development, documentation is invaluable for
future maintainers of a project. As such, Pigweed has integrated documentation
which builds alongside its code and combines with other build features, such as
size reports, to provide high quality, up-to-date references for developers.</p>
<div class="section" id="id2">
<h4>See also<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference internal" href="pw_docgen/docs.html#chapter-pw-docgen"><span class="std std-ref">pw_docgen</span></a></p></li>
</ul>
</div>
</div>
<div class="section" id="unit-testing">
<h3>Unit testing<a class="headerlink" href="#unit-testing" title="Permalink to this headline">¶</a></h3>
<p>Unit tests are essential to ensure that the functionality of code remains
consistent as changes are made to avoid accidental regressions. Running unit
tests as part of a build keeps developers constantly aware of the impact of
their changes.</p>
<div class="section" id="host-side-unit-tests">
<h4>Host-side unit tests<a class="headerlink" href="#host-side-unit-tests" title="Permalink to this headline">¶</a></h4>
<p>Though Pigweed targets embedded devices, a lot of its code can be run and tested
on a host desktop by swapping out backends to host platform libraries. This is
highly beneficial during development, as it allows tests to consistently run
without having to go through the process of flashing a device.</p>
</div>
<div class="section" id="device-side-unit-tests">
<h4>Device-side unit tests<a class="headerlink" href="#device-side-unit-tests" title="Permalink to this headline">¶</a></h4>
<p>As useful as host-side tests are, they are not sufficient for developing actual
firmware, and it is critical to run tests on the actual hardware. Pigweed has
invested into creating a test framework and build integration for running tests
across physical devices as part of a build.</p>
</div>
<div class="section" id="id3">
<h4>See also<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference internal" href="pw_unit_test/docs.html#chapter-pw-unit-test"><span class="std std-ref">pw_unit_test</span></a></p></li>
<li><p><a class="reference internal" href="pw_target_runner/docs.html#chapter-pw-target-runner"><span class="std std-ref">pw_target_runner</span></a></p></li>
</ul>
</div>
</div>
<div class="section" id="bonus-pw-watch">
<h3>Bonus: pw watch<a class="headerlink" href="#bonus-pw-watch" title="Permalink to this headline">¶</a></h3>
<p>In web development, it is common to have a file system watcher listening for
source file changes and triggering a build for quick iteration. When combined
with a fast incremental build system, this becomes a powerful feature, allowing
things such as unit tests and size reports to re-run whenever any dependent
code is modified.</p>
<p>While initially seen as somewhat of a gimmick, Pigweed’s watcher has become a
staple of Pigweed development, with most Pigweed users having it permanently
running in a terminal window.</p>
<div class="section" id="id4">
<h4>See also<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference internal" href="pw_watch/docs.html#chapter-pw-watch"><span class="std std-ref">pw_watch</span></a></p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="pigweed-s-build-systems">
<h2>Pigweed’s build systems<a class="headerlink" href="#pigweed-s-build-systems" title="Permalink to this headline">¶</a></h2>
<p>Pigweed can be used either as a monolith or à la carte, slotting into an
existing project. To this end, Pigweed supports multiple build systems, allowing
Pigweed-based projects to choose the most suitable one for them.</p>
<p>Of the supported build systems, GN is the most full-featured, followed by CMake,
and finally Bazel.</p>
<div class="section" id="cmake">
<h3>CMake<a class="headerlink" href="#cmake" title="Permalink to this headline">¶</a></h3>
<p>A well-known name in C/C++ development, <a class="reference external" href="https://cmake.org/">CMake</a> is widely used by all kinds of
projects, including embedded devices. Pigweed’s CMake support is provided
primarily for projects that have an existing CMake build and wish to integrate
Pigweed modules.</p>
</div>
<div class="section" id="bazel">
<h3>Bazel<a class="headerlink" href="#bazel" title="Permalink to this headline">¶</a></h3>
<p>The open source version of Google’s internal build system. <a class="reference external" href="https://bazel.build/">Bazel</a> has been
growing in popularity within the open source world, as well as being adopted by
various proprietary projects. Its modular structure makes it a great fit for
à la carte usage.</p>
</div>
<div class="section" id="gn">
<h3>GN<a class="headerlink" href="#gn" title="Permalink to this headline">¶</a></h3>
<p>A perhaps unfamiliar name, <a class="reference external" href="https://gn.googlesource.com/gn">GN (Generate Ninja)</a> is a meta-build system that
outputs <a class="reference external" href="https://ninja-build.org/">Ninja</a> build files, originally designed for use in Chromium. Pigweed
first experimented with GN after hearing about it from another team, and we
quickly came to appreciate its speed and simplicity. GN has become Pigweed’s
primary build system; it is used for all upstream development and strongly
recommended for Pigweed-based projects where possible.</p>
</div>
</div>
<div class="section" id="the-gn-build">
<h2>The GN build<a class="headerlink" href="#the-gn-build" title="Permalink to this headline">¶</a></h2>
<p>This section describes Pigweed’s GN build structure, how it is used upstream,
build conventions, and recommendations for Pigweed-based projects. While
containing some details about how GN works in general, this section is not
intended to be a guide on how to use GN. To learn more about the tool itself,
refer to the official <a class="reference external" href="https://gn.googlesource.com/gn/+/master/docs/reference.md">GN reference</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A quick note on terminology: the word “target” is overloaded within GN (and
Pigweed)—it can refer to either a GN build target, such as a <code class="docutils literal notranslate"><span class="pre">source_set</span></code>
or <code class="docutils literal notranslate"><span class="pre">executable</span></code>, or to an output platform (e.g. a specific board, device, or
system).</p>
<p>To avoid confusing the two, we refer to the former as “GN targets” and the
latter as “Pigweed targets”.</p>
</div>
<div class="section" id="entrypoint-gn">
<h3>Entrypoint: .gn<a class="headerlink" href="#entrypoint-gn" title="Permalink to this headline">¶</a></h3>
<p>The entrypoint to a GN build is the <code class="docutils literal notranslate"><span class="pre">.gn</span></code> file, which defines a project’s root
directory (henceforth <code class="docutils literal notranslate"><span class="pre">//</span></code>).</p>
<p><code class="docutils literal notranslate"><span class="pre">.gn</span></code> must point to the location of a <code class="docutils literal notranslate"><span class="pre">BUILDCONFIG.gn</span></code> file for the project.
In Pigweed upstream, this is its only purpose.</p>
<p>Downstream projects may additionally use <code class="docutils literal notranslate"><span class="pre">.gn</span></code> to set global overrides for
Pigweed’s build arguments, which apply across all Pigweed targets. For example,
a project could configure the protobuf libraries that it uses. This is done by
defining a <code class="docutils literal notranslate"><span class="pre">default_args</span></code> scope containing the overrides.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># The location of the BUILDCONFIG file.</span>
<span class="n">buildconfig</span> <span class="o">=</span> <span class="s2">&quot;//BUILDCONFIG.gn&quot;</span>

<span class="c1"># Build arguments set across all Pigweed targets.</span>
<span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">pw_protobuf_GENERATORS</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;nanopb_rpc&quot;</span> <span class="p">]</span>
  <span class="n">dir_pw_third_party_nanopb</span> <span class="o">=</span> <span class="s2">&quot;//third_party/nanopb-0.4.2&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="configuration-buildconfig-gn">
<h3>Configuration: BUILDCONFIG.gn<a class="headerlink" href="#configuration-buildconfig-gn" title="Permalink to this headline">¶</a></h3>
<p>The file <code class="docutils literal notranslate"><span class="pre">BUILDCONFIG.gn</span></code> configures the GN build by defining any desired
global variables/options. It can be located anywhere in the build tree, but is
conventionally placed at the root. <code class="docutils literal notranslate"><span class="pre">.gn</span></code> points GN to this file.</p>
<p><code class="docutils literal notranslate"><span class="pre">BUILDCONFIG.gn</span></code> is evaluated before any other GN files, and variables defined
within it are placed into GN’s global scope, becoming available in every file
without requiring imports.</p>
<p>The options configured in this file differ from those in <code class="docutils literal notranslate"><span class="pre">.gn</span></code> in two ways:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BUILDCONFIG.gn</span></code> is evaluated for every GN toolchain (and Pigweed target),
whereas <code class="docutils literal notranslate"><span class="pre">.gn</span></code> is only evaluated once. This allows <code class="docutils literal notranslate"><span class="pre">BUILDCONFIG.gn</span></code> to set
different options for each Pigweed target.</p></li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">.gn</span></code>, only GN build arguments can be overridden. <code class="docutils literal notranslate"><span class="pre">BUILDCONFIG.gn</span></code>
allows defining arbitrary variables.</p></li>
</ol>
<p>Generally, it is preferable to expose configuration options through build args
instead of globals in <code class="docutils literal notranslate"><span class="pre">BUILDCONFIG.gn</span></code> (something Pigweed’s build previously
did), as they are more flexible, greppable, and easier to manage. However, it
may make sense to define project-specific constants in <code class="docutils literal notranslate"><span class="pre">BUILDCONFIG.gn</span></code>.</p>
<p>Pigweed’s upstream <code class="docutils literal notranslate"><span class="pre">BUILDCONFIG.gn</span></code> does not define any variables; it just
sets Pigweed’s default toolchain, which GN requires.</p>
</div>
<div class="section" id="top-level-gn-targets-build-gn">
<span id="top-level-build"></span><h3>Top-level GN targets: //BUILD.gn<a class="headerlink" href="#top-level-gn-targets-build-gn" title="Permalink to this headline">¶</a></h3>
<p>The root <code class="docutils literal notranslate"><span class="pre">BUILD.gn</span></code> file defines all of the libraries, images, tests, and
binaries built by a Pigweed project. This file is evaluated immediately after
<code class="docutils literal notranslate"><span class="pre">BUILDCONFIG.gn</span></code>, with the active toolchain (which is the default toolchain
at the start of a build).</p>
<p><code class="docutils literal notranslate"><span class="pre">//BUILD.gn</span></code> is responsible for enumerating each of the Pigweed targets built
by a project. This is done by instantiating a version of each of the project’s
GN target groups with each Pigweed target’s toolchain. For example, in upstream,
all of Pigweed’s GN targets are contained within the <code class="docutils literal notranslate"><span class="pre">pigweed_default</span></code> group.
This group is instantiated multiple times, with different Pigweed target
toolchains.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Snippit from Pigweed&#39;s //BUILD.gn</span>

<span class="n">group</span><span class="p">(</span><span class="s2">&quot;host_clang&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;:pigweed_default($dir_pigweed/targets/host:host_clang_$pw_optimization_level)&quot;</span> <span class="p">]</span>
<span class="p">}</span>

<span class="n">group</span><span class="p">(</span><span class="s2">&quot;stm32f429i&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;:pigweed_default($dir_pigweed/targets/stm32f429i-disc1:stm32f429i_disc1_$pw_optimization_level)&quot;</span> <span class="p">]</span>
<span class="p">}</span>

<span class="n">group</span><span class="p">(</span><span class="s2">&quot;docs&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;:pigweed_default($dir_pigweed/targets/docs)&quot;</span> <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Pigweed projects are recommended to follow this pattern, creating a top-level
group for each of its Pigweed targets, which builds a common GN target with the
appropriate toolchain.</p>
<p>It is important that no dependencies are listed under the default toolchain
within <code class="docutils literal notranslate"><span class="pre">//BUILD.gn</span></code>, as it does not configure any build parameters, and
therefore should not evaluate any other GN files. The pattern that Pigweed uses
to achieve this is to wrap all dependencies within a condition checking the
toolchain.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;my_application_images&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">deps</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Empty in the default toolchain.</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">current_toolchain</span> <span class="o">!=</span> <span class="n">default_toolchain</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1"># This is only evaluated by Pigweed target toolchains, which configure</span>
    <span class="c1"># all of the required options to build Pigweed code.</span>
    <span class="n">deps</span> <span class="o">+=</span> <span class="p">[</span> <span class="s2">&quot;//images:evt&quot;</span> <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># The images group is instantiated for each of the project&#39;s Pigweed targets.</span>
<span class="n">group</span><span class="p">(</span><span class="s2">&quot;my_pigwed_target&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;:my_application_images(//toolchains:my_pigweed_target)&quot;</span> <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Pigweed’s default toolchain is never used, so it is set to a dummy toolchain
which doesn’t define any tools. <code class="docutils literal notranslate"><span class="pre">//BUILD.gn</span></code> contains conditions which check
that the current toolchain is not the default before declaring any GN target
dependencies to prevent the default toolchain from evaluating any other BUILD
files. All GN targets added to the build must be placed under one of these
conditional scopes.</p>
</div>
<div class="section" id="default-group">
<h4>“default” group<a class="headerlink" href="#default-group" title="Permalink to this headline">¶</a></h4>
<p>The root <code class="docutils literal notranslate"><span class="pre">BUILD.gn</span></code> file can define a special group named <code class="docutils literal notranslate"><span class="pre">default</span></code>. If
present, Ninja will build this group when invoked without arguments.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Defining a <code class="docutils literal notranslate"><span class="pre">default</span></code> group makes using <code class="docutils literal notranslate"><span class="pre">pw</span> <span class="pre">watch</span></code> simple!</p>
</div>
</div>
<div class="section" id="upstream-gn-target-groups">
<h4>Upstream GN target groups<a class="headerlink" href="#upstream-gn-target-groups" title="Permalink to this headline">¶</a></h4>
<p>In upstream, Pigweed splits its top-level GN targets into a few logical groups,
which are described below. In order to build a GN target, it <em>must</em> be listed in
one of the groups in this file.</p>
<div class="section" id="apps">
<h5>apps<a class="headerlink" href="#apps" title="Permalink to this headline">¶</a></h5>
<p>This group defines the application images built in Pigweed. It lists all of the
common images built across all Pigweed targets, such as modules’ example
executables. Each Pigweed target can additionally provide its own specific
images through the <code class="docutils literal notranslate"><span class="pre">pw_TARGET_APPLICATIONS</span></code> build arg, which is included by
this group.</p>
</div>
<div class="section" id="host-tools">
<h5>host_tools<a class="headerlink" href="#host-tools" title="Permalink to this headline">¶</a></h5>
<p>This group defines host-side tooling binaries built for Pigweed.</p>
</div>
<div class="section" id="pw-modules">
<h5>pw_modules<a class="headerlink" href="#pw-modules" title="Permalink to this headline">¶</a></h5>
<p>This group lists the main libraries for all of Pigweed’s modules.</p>
</div>
<div class="section" id="pw-module-tests">
<h5>pw_module_tests<a class="headerlink" href="#pw-module-tests" title="Permalink to this headline">¶</a></h5>
<p>All modules’ unit tests are collected here, so that they can all be run at once.</p>
</div>
<div class="section" id="pigweed-default">
<h5>pigweed_default<a class="headerlink" href="#pigweed-default" title="Permalink to this headline">¶</a></h5>
<p>This group defines everything built in a Pigweed build invocation by collecting
the above groups and conditionally depending on them based on the active Pigweed
target’s configuration. Generally, new dependencies should not be added here;
instead, use one of the groups listed above.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">pigweed_default</span></code> group is instantiated for each upstream Pigweed target’s
toolchain.</p>
</div>
<div class="section" id="pigweed-target-instantiations">
<h5>Pigweed target instantiations<a class="headerlink" href="#pigweed-target-instantiations" title="Permalink to this headline">¶</a></h5>
<p>These groups wrap <code class="docutils literal notranslate"><span class="pre">pigweed_default</span></code> with a specific target toolchain. They are
named after the Pigweed target, e.g. <code class="docutils literal notranslate"><span class="pre">host_clang</span></code>, <code class="docutils literal notranslate"><span class="pre">stm32f429i</span></code>, etc.</p>
</div>
</div>
</div>
<div class="section" id="other-build-files-build-gn">
<h3>Other BUILD files: //**/BUILD.gn<a class="headerlink" href="#other-build-files-build-gn" title="Permalink to this headline">¶</a></h3>
<p>The rest of the <code class="docutils literal notranslate"><span class="pre">BUILD.gn</span></code> files in the tree define libraries, configs, and
build args for each of the modules in a Pigweed project.</p>
</div>
<div class="section" id="project-configuration-build-overrides-pigweed-gni">
<h3>Project configuration: //build_overrides/pigweed.gni<a class="headerlink" href="#project-configuration-build-overrides-pigweed-gni" title="Permalink to this headline">¶</a></h3>
<p>Each Pigweed project must contain a Pigweed configuration file at a known
location in the GN build tree. Currently, this file only contains a single build
argument, which must be set to the GN build path to the root of the Pigweed
repository within the project.</p>
</div>
<div class="section" id="module-variables">
<h3>Module variables<a class="headerlink" href="#module-variables" title="Permalink to this headline">¶</a></h3>
<p>As Pigweed is inteded to be a subcomponent of a larger project, it cannot assume
where it or its modules is located. Therefore, Pigweed’s upstream BUILD.gn files
do not use absolute paths; instead, variables are defined pointing to each of
Pigweed’s modules, set relative to a project-specific <code class="docutils literal notranslate"><span class="pre">dir_pigweed</span></code>.</p>
<p>To depend on Pigweed modules from GN code, import Pigweed’s overrides file and
reference these module variables.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This must be imported before .gni files from any other Pigweed modules.</span>
<span class="c1"># To prevent gn format from reordering this import, a comment is added above.</span>
<span class="n">import</span><span class="p">(</span><span class="s2">&quot;//build_overrides/pigweed.gni&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="gn-target-type-wrappers">
<h3>GN target type wrappers<a class="headerlink" href="#gn-target-type-wrappers" title="Permalink to this headline">¶</a></h3>
<p>To faciliate injecting global configuration options, Pigweed defines wrappers
around builtin GN target types such as <code class="docutils literal notranslate"><span class="pre">source_set</span></code> and <code class="docutils literal notranslate"><span class="pre">executable</span></code>. These
are defined within <code class="docutils literal notranslate"><span class="pre">$dir_pw_build/target_types.gni</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To take advantage of Pigweed’s flexible target configuration system, use
<code class="docutils literal notranslate"><span class="pre">pw_*</span></code> target types (e.g. <code class="docutils literal notranslate"><span class="pre">pw_source_set</span></code>) in your BUILD.gn files instead
of GN builtins.</p>
</div>
</div>
<div class="section" id="pigweed-targets">
<h3>Pigweed targets<a class="headerlink" href="#pigweed-targets" title="Permalink to this headline">¶</a></h3>
<p>To build for a specific hardware platform, builds define Pigweed targets. These
are essentially GN toolchains which set special arguments telling Pigweed how to
build. For information on Pigweed’s target system, refer to
<a class="reference internal" href="targets.html#chapter-targets"><span class="std std-ref">Targets</span></a>.</p>
</div>
<div class="section" id="the-dummy-toolchain">
<h3>The dummy toolchain<a class="headerlink" href="#the-dummy-toolchain" title="Permalink to this headline">¶</a></h3>
<p>Pigweed’s <code class="docutils literal notranslate"><span class="pre">BUILDCONFIG.gn</span></code> sets the project’s default toolchain to a “dummy”
toolchain which does not specify any compilers or override any build arguments.
Downstream projects are recommended to do the same, following the steps
described in <a class="reference internal" href="#top-level-build"><span class="std std-ref">Top-level GN targets: //BUILD.gn</span></a> to configure builds for each of their
Pigweed targets.</p>
<div class="admonition-why-use-a-dummy admonition">
<p class="admonition-title">Why use a dummy?</p>
<p>To support some of its advanced (and useful!) build features, Pigweed requires
the ability to generate new toolchains on the fly. This requires having
knowledge of the full configuration of the current toolchain (which is easy if
it’s all defined within a scope), something which is impractical to achieve
using the default toolchain.</p>
<p>Additionally, there are some cases where GN treats default and non-default
toolchains differently. By not using the default toolchain, we avoid having
to deal with these inconsistencies.</p>
<p>It is possible to build Pigweed using only the default toolchain, but it
requires a more complicated setup to get everything working and should be
avoided unless necessary (for example, when integrating with a large existing
GN-based project).</p>
</div>
</div>
<div class="section" id="upstream-development-examples">
<h3>Upstream development examples<a class="headerlink" href="#upstream-development-examples" title="Permalink to this headline">¶</a></h3>
<p>If developing for upstream Pigweed, some common build use cases are described
below.</p>
<div class="section" id="building-a-custom-executable-app-image">
<h4>Building a custom executable/app image<a class="headerlink" href="#building-a-custom-executable-app-image" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p>Define your executable GN target using the <code class="docutils literal notranslate"><span class="pre">pw_executable</span></code> template.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># //foo/BUILD.gn</span>
<span class="n">pw_executable</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;main.cc&quot;</span> <span class="p">]</span>
  <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;:libfoo&quot;</span> <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>In the root <code class="docutils literal notranslate"><span class="pre">BUILD.gn</span></code> file, add the executable’s GN target to the <code class="docutils literal notranslate"><span class="pre">apps</span></code>
group.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># //BUILD.gn</span>
<span class="n">group</span><span class="p">(</span><span class="s2">&quot;apps&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="s2">&quot;//foo&quot;</span><span class="p">,</span>  <span class="c1"># Shorthand for //foo:foo</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Run the ninja build to compile your executable. The apps group is built by
default, so there’s no need to provide a target. The executable will be
compiled for every supported Pigweed target.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ninja</span> <span class="o">-</span><span class="n">C</span> <span class="n">out</span>
</pre></div>
</div>
<p>Alternatively, build your executable by itself by specifying its path to
Ninja. When building a GN target manually, the Pigweed target for which it
is built must be specified on the Ninja command line.</p>
<p>For example, to build for the Pigweed target <code class="docutils literal notranslate"><span class="pre">host_gcc_debug</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ninja</span> <span class="o">-</span><span class="n">C</span> <span class="n">out</span> <span class="n">host_gcc_debug</span><span class="o">/</span><span class="n">obj</span><span class="o">/</span><span class="n">foo</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">foo</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The path passed to Ninja is a filesystem path within the <code class="docutils literal notranslate"><span class="pre">out</span></code> directory,
rather than a GN path. This path can be found by running <code class="docutils literal notranslate"><span class="pre">gn</span> <span class="pre">outputs</span></code>.</p>
</div>
</li>
<li><p>Retrieve your compiled binary from the out directory. It is located at the
path</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">out</span><span class="o">/&lt;</span><span class="n">pw_target</span><span class="o">&gt;/</span><span class="n">obj</span><span class="o">/&lt;</span><span class="n">gn_path</span><span class="o">&gt;/</span><span class="p">{</span><span class="nb">bin</span><span class="p">,</span><span class="n">test</span><span class="p">}</span><span class="o">/&lt;</span><span class="n">executable</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">pw_target</span></code> is the Pigweed target for which the binary was built,
<code class="docutils literal notranslate"><span class="pre">gn_path</span></code> is the GN path to the BUILD.gn file defining the executable,
and <code class="docutils literal notranslate"><span class="pre">executable</span></code> is the executable’s GN target name (potentially with an
extension). Note that the executable is located within a <code class="docutils literal notranslate"><span class="pre">bin</span></code> subdirectory
in the module (or <code class="docutils literal notranslate"><span class="pre">test</span></code> for unit tests defined with <code class="docutils literal notranslate"><span class="pre">pw_test</span></code>).</p>
<p>For example, the <code class="docutils literal notranslate"><span class="pre">foo</span></code> executable defined above and compiled for the
Pigweed target stm32f429i_disc1_debug is found at:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">out</span><span class="o">/</span><span class="n">stm32f429i_disc1_debug</span><span class="o">/</span><span class="n">obj</span><span class="o">/</span><span class="n">foo</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">foo</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="docs/faq.html" class="btn btn-neutral float-right" title="Frequently Asked Questions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="targets/stm32f429i-disc1/target_docs.html" class="btn btn-neutral float-left" title="stm32f429i-disc1" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020 The Pigweed Authors

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
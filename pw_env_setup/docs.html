

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pw_env_setup &mdash; Pigweed</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="pw_fuzzer" href="../pw_fuzzer/docs.html" />
    <link rel="prev" title="pw_doctor" href="../pw_doctor/docs.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Pigweed
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pigweed.googlesource.com/pigweed/pigweed/+/refs/heads/master">Source Code</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pigweed-review.googlesource.com">Code Reviews</a></li>
<li class="toctree-l1"><a class="reference external" href="https://groups.google.com/forum/#!forum/pigweed">Mailing List</a></li>
<li class="toctree-l1"><a class="reference external" href="https://discord.gg/M9NSeTA">Chat Room</a></li>
<li class="toctree-l1"><a class="reference external" href="https://bugs.chromium.org/p/pigweed/issues/list">Issue Tracker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CODE_OF_CONDUCT.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/embedded_cpp_guide.html">Embedded C++ Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/style_guide.html">Code Style</a></li>
<li class="toctree-l1"><a class="reference internal" href="../targets.html">Targets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build_system.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/module_structure.html">Module Structure</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../module_guides.html">Module Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../docker/docs.html">docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_allocator/docs.html">pw_allocator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_arduino_build/docs.html">pw_arduino_build</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_assert/docs.html">pw_assert</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_assert_basic/docs.html">pw_assert_basic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_assert_log/docs.html">pw_assert_log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_base64/docs.html">pw_base64</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_bloat/docs.html">pw_bloat</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_blob_store/docs.html">pw_blob_store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_boot_armv7m/docs.html">pw_boot_armv7m</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_build/docs.html">pw_build</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_bytes/docs.html">pw_bytes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_checksum/docs.html">pw_checksum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_cli/docs.html">pw_cli</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_containers/docs.html">pw_containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_cpu_exception/docs.html">pw_cpu_exception</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_cpu_exception_armv7m/docs.html">pw_cpu_exception_armv7m</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_docgen/docs.html">pw_docgen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_doctor/docs.html">pw_doctor</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">pw_env_setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-pw-env-setup-in-your-project">Using pw_env_setup in your project</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#user-friendliness">User-Friendliness</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation">Implementation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../pw_fuzzer/docs.html">pw_fuzzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_hdlc_lite/docs.html">pw_hdlc_lite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_hex_dump/docs.html">pw_hex_dump</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_kvs/docs.html">pw_kvs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_log/docs.html">pw_log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_log_basic/docs.html">pw_log_basic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_log_null/docs.html">pw_log_null</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_log_rpc/docs.html">pw_log_rpc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_log_tokenized/docs.html">pw_log_tokenized</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_metric/docs.html">pw_metric</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_minimal_cpp_stdlib/docs.html">pw_minimal_cpp_stdlib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_module/docs.html">pw_module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_polyfill/docs.html">pw_polyfill</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_preprocessor/docs.html">pw_preprocessor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_presubmit/docs.html">pw_presubmit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_protobuf/docs.html">pw_protobuf</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_protobuf_compiler/docs.html">pw_protobuf_compiler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_random/docs.html">pw_random</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_result/docs.html">pw_result</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_ring_buffer/docs.html">pw_ring_buffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_rpc/docs.html">pw_rpc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_span/docs.html">pw_span</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_status/docs.html">pw_status</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_stream/docs.html">pw_stream</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_string/docs.html">pw_string</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_sys_io/docs.html">pw_sys_io</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_sys_io_arduino/docs.html">pw_sys_io_arduino</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_sys_io_baremetal_stm32f429/docs.html">pw_sys_io_baremetal_stm32f429</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_sys_io_stdio/docs.html">pw_sys_io_stdio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_target_runner/docs.html">pw_target_runner</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_tokenizer/docs.html">pw_tokenizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_toolchain/docs.html">pw_toolchain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_trace/docs.html">pw_trace</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_trace_tokenized/docs.html">pw_trace_tokenized</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_unit_test/docs.html">pw_unit_test</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_varint/docs.html">pw_varint</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_watch/docs.html">pw_watch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_web_ui/docs.html">pw_web_ui</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Pigweed</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../module_guides.html">Module Guides</a> &raquo;</li>
        
      <li>pw_env_setup</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="pw-env-setup">
<span id="module-pw-env-setup"></span><h1>pw_env_setup<a class="headerlink" href="#pw-env-setup" title="Permalink to this headline">¶</a></h1>
<p>A classic problem in the embedded space is reducing the time from git clone
to having a binary executing on a device. The issue is that an entire suite
of tools is needed for non-trivial production embedded projects. For example:</p>
<blockquote>
<div><ul class="simple">
<li><p>A C++ compiler for your target device, and also for your host</p></li>
<li><p>A build system or three; for example, GN, Ninja, CMake, Bazel</p></li>
<li><p>A code formatting program like clang-format</p></li>
<li><p>A debugger like OpenOCD to flash and debug your embedded device</p></li>
<li><p>A known Python version with known modules installed for scripting</p></li>
<li><p>A Go compiler for the Go-based command line tools</p></li>
</ul>
</div></blockquote>
<p>…and so on</p>
<p>In the server space, container solutions like Docker or Podman solve this;
however, in our experience container solutions are a mixed bag for embedded
systems development where one frequently needs access to native system
resources like USB devices, or must operate on Windows.</p>
<p><code class="docutils literal notranslate"><span class="pre">pw_env_setup</span></code> is our compromise solution for this problem that works on Mac,
Windows, and Linux. It leverages the Chrome packaging system <a class="reference external" href="https://github.com/luci/luci-go/tree/master/cipd">CIPD</a> to
bootstrap a Python installation, which in turn inflates a virtual
environment. The tooling is installed into your workspace, and makes no
changes to your system. This tooling is designed to be reused by any
project.</p>
<p>Users interact with  <code class="docutils literal notranslate"><span class="pre">pw_env_setup</span></code> with two commands: <code class="docutils literal notranslate"><span class="pre">.</span> <span class="pre">bootstrap.sh</span></code> and
<code class="docutils literal notranslate"><span class="pre">.</span> <span class="pre">activate.sh</span></code>. The bootstrap command always pulls down the current versions
of CIPD packages and sets up the Python virtual environment. The activate
command reinitializes a previously configured environment, and if none is found,
runs bootstrap.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On Windows the scripts used to set up the environment are <code class="docutils literal notranslate"><span class="pre">bootstrap.bat</span></code>
and <code class="docutils literal notranslate"><span class="pre">activate.bat</span></code>. For simplicity they will be referred to with the <code class="docutils literal notranslate"><span class="pre">.sh</span></code>
endings unless the distinction is relevant.</p>
</div>
<p>By default packages will be installed in a <code class="docutils literal notranslate"><span class="pre">.environment</span></code> folder within the
checkout root, and CIPD will cache files in <code class="docutils literal notranslate"><span class="pre">$HOME/.cipd-cache-dir</span></code>. These
paths can be overridden by setting <code class="docutils literal notranslate"><span class="pre">PW_ENVIRONMENT_ROOT</span></code> and
<code class="docutils literal notranslate"><span class="pre">CIPD_CACHE_DIR</span></code>, respectively.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>At this time <code class="docutils literal notranslate"><span class="pre">pw_env_setup</span></code> works for us, but isn’t well tested. We don’t
suggest relying on it just yet. However, we are interested in experience
reports; if you give it a try, please <a class="reference external" href="mailto:pigweed&#37;&#52;&#48;googlegroups&#46;com">send us a note</a> about your
experience.</p>
</div>
<div class="section" id="using-pw-env-setup-in-your-project">
<h2>Using pw_env_setup in your project<a class="headerlink" href="#using-pw-env-setup-in-your-project" title="Permalink to this headline">¶</a></h2>
<p>Projects using Pigweed can leverage <code class="docutils literal notranslate"><span class="pre">pw_env_setup</span></code> to install their own
dependencies. The following environment variables are now used to pass options
into pw_env_setup.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PW_CIPD_PACKAGE_FILES</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PW_VIRTUALENV_REQUIREMENTS</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PW_VIRTUALENV_REQUIREMENTS_APPEND_DEFAULT</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PW_VIRTUALENV_SETUP_PY_ROOTS</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PW_CARGO_PACKAGE_FILES</span></code></p></li>
</ul>
</div></blockquote>
<p>Each of these variables can contain multiple entries separated by <code class="docutils literal notranslate"><span class="pre">:</span></code>
(or <code class="docutils literal notranslate"><span class="pre">;</span></code> on Windows) like the <code class="docutils literal notranslate"><span class="pre">PATH</span></code> environment variable. However, they
will also be interpreted as globs, so
<code class="docutils literal notranslate"><span class="pre">PW_VIRTUALENV_REQUIREMENTS=&quot;/foo/bar/*/requirements.txt&quot;</span></code> is perfectly
valid. They should be full paths.</p>
<p>Projects depending on Pigweed should set these variables and then invoke
Pigweed’s <code class="docutils literal notranslate"><span class="pre">bootstrap.sh</span></code> (or <code class="docutils literal notranslate"><span class="pre">bootstrap.bat</span></code>), which will add to each of
these variables before invoking <code class="docutils literal notranslate"><span class="pre">pw_env_setup</span></code>. Users wanting additional
setup can set these variables in their shell init files. Pigweed will add to
these variables and will not remove any existing values. At the end of
Pigweed’s bootstrap process, it will reset these variables to their initial
values.</p>
<p>An example of what your project’s <cite>bootstrap.sh</cite> could look like is below. This
assumes <cite>bootstrap.sh</cite> is at the top level of your repository.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do not include a &quot;#!&quot; line, this must be sourced and not executed.</span>

<span class="c1"># This assumes the user is sourcing this file from it&#39;s parent directory. See</span>
<span class="c1"># below for a more flexible way to handle this.</span>
<span class="nv">PROJ_SETUP_SCRIPT_PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">/bootstrap.sh&quot;</span>

<span class="nb">export</span> <span class="nv">PROJ_ROOT</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>_python_abspath <span class="s2">&quot;</span><span class="k">$(</span>dirname <span class="s2">&quot;</span><span class="nv">$PROJ_SETUP_SCRIPT_PATH</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>

<span class="c1"># You may wish to check if the user is attempting to execute this script</span>
<span class="c1"># instead of sourcing it. See below for an example of how to handle that</span>
<span class="c1"># situation.</span>

<span class="c1"># Add the project-specific CIPD manifest.</span>
<span class="nv">PW_CIPD_PACKAGE_FILES</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PROJ_ROOT</span><span class="s2">/tools/cipd.json:</span><span class="nv">$PW_CIPD_PACKAGE_FILES</span><span class="s2">&quot;</span>
<span class="nb">export</span> PW_CIPD_PACKAGE_FILES

<span class="c1"># Add the tools folder of this repository to the search path for setup.py</span>
<span class="c1"># files.</span>
<span class="nv">PW_VIRTUALENV_SETUP_PY_ROOTS</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PROJ_ROOT</span><span class="s2">/tools:</span><span class="nv">$PW_VIRTUALENV_SETUP_PY_ROOTS</span><span class="s2">&quot;</span>
<span class="nb">export</span> PW_VIRTUALENV_SETUP_PY_ROOTS

<span class="c1"># Process the project-specific requirements.txt file.</span>
<span class="nv">PW_VIRTUALENV_REQUIREMENTS</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PROJ_ROOT</span><span class="s2">/tools/requirements.txt:</span><span class="nv">$PW_VIRTUALENV_REQUIREMENTS</span><span class="s2">&quot;</span>
<span class="nb">export</span> PW_VIRTUALENV_REQUIREMENTS

<span class="c1"># Add default requirements (if requirements don&#39;t conflict)</span>
<span class="nv">PW_VIRTUALENV_REQUIREMENTS_APPEND_DEFAULT</span><span class="o">=</span><span class="m">1</span>

<span class="c1"># Source Pigweed&#39;s bootstrap script.</span>
<span class="c1"># Using &#39;.&#39; instead of &#39;source&#39; for dash compatibility. Since users don&#39;t use</span>
<span class="c1"># dash directly, using &#39;source&#39; in documentation so users don&#39;t get confused</span>
<span class="c1"># and try to `./bootstrap.sh`.</span>
. <span class="s2">&quot;</span><span class="nv">$PROJ_ROOT</span><span class="s2">/third_party/pigweed/</span><span class="k">$(</span>basename <span class="s2">&quot;</span><span class="nv">$PROJ_SETUP_SCRIPT_PATH</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
</pre></div>
</div>
<div class="section" id="user-friendliness">
<h3>User-Friendliness<a class="headerlink" href="#user-friendliness" title="Permalink to this headline">¶</a></h3>
<p>You may wish to allow sourcing <cite>bootstrap.sh</cite> from a different directory. In
that case you’ll need the following at the top of <cite>bootstrap.sh</cite>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>_python_abspath <span class="o">()</span> <span class="o">{</span>
  python -c <span class="s2">&quot;import os.path; print(os.path.abspath(&#39;</span><span class="nv">$@</span><span class="s2">&#39;))&quot;</span>
<span class="o">}</span>

<span class="c1"># Use this code from Pigweed&#39;s bootstrap to find the path to this script when</span>
<span class="c1"># sourced. This should work with common shells. PW_CHECKOUT_ROOT is only used in</span>
<span class="c1"># presubmit tests with strange setups, and can be omitted if you&#39;re not using</span>
<span class="c1"># Pigweed&#39;s automated testing infrastructure.</span>
<span class="k">if</span> <span class="nb">test</span> -n <span class="s2">&quot;</span><span class="nv">$PW_CHECKOUT_ROOT</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">then</span>
  <span class="nv">PROJ_SETUP_SCRIPT_PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>_python_abspath <span class="s2">&quot;</span><span class="nv">$PW_CHECKOUT_ROOT</span><span class="s2">/bootstrap.sh&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
  <span class="nb">unset</span> PW_CHECKOUT_ROOT
<span class="c1"># Shell: bash.</span>
<span class="k">elif</span> <span class="nb">test</span> -n <span class="s2">&quot;</span><span class="nv">$BASH</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">then</span>
  <span class="nv">PROJ_SETUP_SCRIPT_PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>_python_abspath <span class="s2">&quot;</span><span class="nv">$BASH_SOURCE</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="c1"># Shell: zsh.</span>
<span class="k">elif</span> <span class="nb">test</span> -n <span class="s2">&quot;</span><span class="nv">$ZSH_NAME</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">then</span>
  <span class="nv">PROJ_SETUP_SCRIPT_PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>_python_abspath <span class="s2">&quot;</span><span class="si">${</span><span class="p">(%)</span><span class="k">:-</span><span class="p">%N</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="c1"># Shell: dash.</span>
<span class="k">elif</span> <span class="nb">test</span> <span class="si">${</span><span class="nv">0</span><span class="p">##*/</span><span class="si">}</span> <span class="o">=</span> dash<span class="p">;</span> <span class="k">then</span>
  <span class="nv">PROJ_SETUP_SCRIPT_PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>_python_abspath <span class="se">\</span>
    <span class="s2">&quot;</span><span class="k">$(</span>lsof -p <span class="nv">$$</span> -Fn0 <span class="p">|</span> tail -1 <span class="p">|</span> sed <span class="s1">&#39;s#^[^/]*##;&#39;</span><span class="k">)</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="c1"># If everything else fails, try $0. It could work.</span>
<span class="k">else</span>
  <span class="nv">PROJ_SETUP_SCRIPT_PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>_python_abspath <span class="s2">&quot;</span><span class="nv">$0</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="k">fi</span>
</pre></div>
</div>
<p>You may also wish to check if the user is attempting to execute <cite>bootstrap.sh</cite>
instead of sourcing it. Executing <cite>bootstrap.sh</cite> would download everything
required for the environment, but cannot modify the environment of the parent
process. To check for this add the following.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check if this file is being executed or sourced.</span>
<span class="nv">_pw_sourced</span><span class="o">=</span><span class="m">0</span>
<span class="c1"># If not running in Pigweed&#39;s automated testing infrastructure the</span>
<span class="c1"># SWARMING_BOT_ID check is unnecessary.</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$SWARMING_BOT_ID</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="c1"># If set we&#39;re running on swarming and don&#39;t need this check.</span>
  <span class="nv">_pw_sourced</span><span class="o">=</span><span class="m">1</span>
<span class="k">elif</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$ZSH_EVAL_CONTEXT</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="k">case</span> <span class="nv">$ZSH_EVAL_CONTEXT</span> in *:file<span class="o">)</span> <span class="nv">_pw_sourced</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span> <span class="k">esac</span>
<span class="k">elif</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$KSH_VERSION</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="o">[</span> <span class="s2">&quot;</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname -- <span class="nv">$0</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span> -P<span class="k">)</span><span class="s2">/</span><span class="k">$(</span>basename -- <span class="nv">$0</span><span class="k">)</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="se">\</span>
    <span class="s2">&quot;</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname -- <span class="si">${</span><span class="p">.sh.file</span><span class="si">}</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span> -P<span class="k">)</span><span class="s2">/</span><span class="k">$(</span>basename -- <span class="si">${</span><span class="p">.sh.file</span><span class="si">}</span><span class="k">)</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nv">_pw_sourced</span><span class="o">=</span><span class="m">1</span>
<span class="k">elif</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$BASH_VERSION</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="o">(</span><span class="k">return</span> <span class="m">0</span> <span class="m">2</span>&gt;/dev/null<span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="nv">_pw_sourced</span><span class="o">=</span><span class="m">1</span>
<span class="k">else</span>  <span class="c1"># All other shells: examine $0 for known shell binary filenames</span>
  <span class="c1"># Detects `sh` and `dash`; add additional shell filenames as needed.</span>
  <span class="k">case</span> <span class="si">${</span><span class="nv">0</span><span class="p">##*/</span><span class="si">}</span> in sh<span class="p">|</span>dash<span class="o">)</span> <span class="nv">_pw_sourced</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span> <span class="k">esac</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$_pw_sourced</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nv">_S_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;</span><span class="nv">$PROJ_SETUP_SCRIPT_PATH</span><span class="s2">&quot;</span> .sh<span class="k">)</span>
  <span class="nb">echo</span> <span class="s2">&quot;Error: Attempting to </span><span class="nv">$_S_NAME</span><span class="s2"> in a subshell&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;  Since </span><span class="nv">$_S_NAME</span><span class="s2">.sh modifies your shell&#39;s environment variables, it&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;  must be sourced rather than executed. In particular, &quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;  &#39;bash </span><span class="nv">$_S_NAME</span><span class="s2">.sh&#39; will not work since the modified environment &quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;  will get destroyed at the end of the script. Instead, source the &quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;  script&#39;s contents in your shell:&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;    \$ source </span><span class="nv">$_S_NAME</span><span class="s2">.sh&quot;</span>
  <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>
</pre></div>
</div>
</div>
<div class="section" id="implementation">
<h3>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h3>
<p>The environment is set up by installing CIPD and Python packages in
<code class="docutils literal notranslate"><span class="pre">PW_ENVIRONMENT_ROOT</span></code> or <code class="docutils literal notranslate"><span class="pre">&lt;checkout&gt;/.environment</span></code>, and saving modifications
to environment variables in setup scripts in those directories. To support
multiple operating systems this is done in an operating system-agnostic manner
and then written into operating system-specific files to be sourced now and in
the future when running <code class="docutils literal notranslate"><span class="pre">activate.sh</span></code> instead of <code class="docutils literal notranslate"><span class="pre">bootstrap.sh</span></code>. In the
future these could be extended to C shell and PowerShell. A logical mapping of
high-level commands to system-specific initialization files is shown below.</p>
<img alt="Mapping of high-level commands to system-specific commands." class="align-left" src="../_images/pw_env_setup_output.png" />
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../pw_fuzzer/docs.html" class="btn btn-neutral float-right" title="pw_fuzzer" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../pw_doctor/docs.html" class="btn btn-neutral float-left" title="pw_doctor" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020 The Pigweed Authors

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
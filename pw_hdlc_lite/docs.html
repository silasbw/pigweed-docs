

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pw_hdlc_lite &mdash; Pigweed</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="pw_hex_dump" href="../pw_hex_dump/docs.html" />
    <link rel="prev" title="pw_fuzzer" href="../pw_fuzzer/docs.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Pigweed
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pigweed.googlesource.com/pigweed/pigweed/+/refs/heads/master">Source Code</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pigweed-review.googlesource.com">Code Reviews</a></li>
<li class="toctree-l1"><a class="reference external" href="https://groups.google.com/forum/#!forum/pigweed">Mailing List</a></li>
<li class="toctree-l1"><a class="reference external" href="https://discord.gg/M9NSeTA">Chat Room</a></li>
<li class="toctree-l1"><a class="reference external" href="https://bugs.chromium.org/p/pigweed/issues/list">Issue Tracker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CODE_OF_CONDUCT.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/embedded_cpp_guide.html">Embedded C++ Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/style_guide.html">Code Style</a></li>
<li class="toctree-l1"><a class="reference internal" href="../targets.html">Targets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build_system.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/module_structure.html">Module Structure</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../module_guides.html">Module Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../docker/docs.html">docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_allocator/docs.html">pw_allocator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_assert/docs.html">pw_assert</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_assert_basic/docs.html">pw_assert_basic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_assert_log/docs.html">pw_assert_log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_base64/docs.html">pw_base64</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_bloat/docs.html">pw_bloat</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_blob_store/docs.html">pw_blob_store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_boot_armv7m/docs.html">pw_boot_armv7m</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_build/docs.html">pw_build</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_bytes/docs.html">pw_bytes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_checksum/docs.html">pw_checksum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_cli/docs.html">pw_cli</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_containers/docs.html">pw_containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_cpu_exception/docs.html">pw_cpu_exception</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_cpu_exception_armv7m/docs.html">pw_cpu_exception_armv7m</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_docgen/docs.html">pw_docgen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_doctor/docs.html">pw_doctor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_env_setup/docs.html">pw_env_setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_fuzzer/docs.html">pw_fuzzer</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">pw_hdlc_lite</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#compatibility">Compatibility</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hdlc-lite-overview">HDLC-Lite Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#basic-overview">Basic Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#protocol-description">Protocol Description</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#encoding-and-sending-data">Encoding and sending data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#decoding-received-bytes">Decoding received bytes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#api-usage">API Usage</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#encoder">Encoder</a></li>
<li class="toctree-l4"><a class="reference internal" href="#decoder">Decoder</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#features">Features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pw-stream-serialwriter">pw::stream::SerialWriter</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#roadmap-status">Roadmap &amp; Status</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../pw_hex_dump/docs.html">pw_hex_dump</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_kvs/docs.html">pw_kvs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_log/docs.html">pw_log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_log_basic/docs.html">pw_log_basic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_log_null/docs.html">pw_log_null</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_log_tokenized/docs.html">pw_log_tokenized</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_metric/docs.html">pw_metric</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_minimal_cpp_stdlib/docs.html">pw_minimal_cpp_stdlib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_module/docs.html">pw_module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_polyfill/docs.html">pw_polyfill</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_preprocessor/docs.html">pw_preprocessor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_presubmit/docs.html">pw_presubmit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_protobuf/docs.html">pw_protobuf</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_protobuf_compiler/docs.html">pw_protobuf_compiler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_random/docs.html">pw_random</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_result/docs.html">pw_result</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_ring_buffer/docs.html">pw_ring_buffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_rpc/docs.html">pw_rpc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_span/docs.html">pw_span</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_status/docs.html">pw_status</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_stream/docs.html">pw_stream</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_string/docs.html">pw_string</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_sys_io/docs.html">pw_sys_io</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_sys_io_baremetal_stm32f429/docs.html">pw_sys_io_baremetal_stm32f429</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_sys_io_stdio/docs.html">pw_sys_io_stdio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_target_runner/docs.html">pw_target_runner</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_tokenizer/docs.html">pw_tokenizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_toolchain/docs.html">pw_toolchain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_trace/docs.html">pw_trace</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_trace_tokenized/docs.html">pw_trace_tokenized</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_unit_test/docs.html">pw_unit_test</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_varint/docs.html">pw_varint</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_watch/docs.html">pw_watch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_web_ui/docs.html">pw_web_ui</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Pigweed</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../module_guides.html">Module Guides</a> &raquo;</li>
        
      <li>pw_hdlc_lite</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="pw-hdlc-lite">
<h1>pw_hdlc_lite<a class="headerlink" href="#pw-hdlc-lite" title="Permalink to this headline">¶</a></h1>
<p>pw_hdlc_lite is a module that enables serial communication between devices
using the HDLC-Lite protocol.</p>
<div class="section" id="compatibility">
<h2>Compatibility<a class="headerlink" href="#compatibility" title="Permalink to this headline">¶</a></h2>
<p>C++17</p>
</div>
<div class="section" id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pw_bytes</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pw_log</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pw_preprocessor</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pw_result</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pw_rpc</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pw_status</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pw_span</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pw_stream</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pw_sys_io</span></code></p></li>
</ul>
</div>
<div class="section" id="hdlc-lite-overview">
<h2>HDLC-Lite Overview<a class="headerlink" href="#hdlc-lite-overview" title="Permalink to this headline">¶</a></h2>
<p>High-Level Data Link Control (HDLC) is a data link layer protocol which uses
synchronous serial transmissions for communication between two devices. Unlike
the standard HDLC protocol which uses six fields of embedded information, the
HDLC-Lite protocol is a minimal version that only uses the bare essentials.</p>
<p>The HDLC-Lite data frame in <code class="docutils literal notranslate"><span class="pre">pw_hdlc_lite</span></code> uses a start and end frame
delimiter (0x7E), the escaped binary payload and the CCITT-CRC16 value.
It looks like:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>                                    [More frames]
_________________________________________   _______
| |                              |  | | |...|   | |
| |                              |  | | |...|   | |
|_|______________________________|__|_|_|...|___|_|
 F         Payload               CRC F F     CRC F
</pre></div>
</div>
</div>
<div class="section" id="basic-overview">
<h2>Basic Overview<a class="headerlink" href="#basic-overview" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">pw_hdlc_lite</span></code> module provides a simple, reliable packet-oriented
transport that uses the HDLC-Lite protocol to send and receive data to and from
embedded devices. This is especially needed for making RPC calls on devices
during testing because the <code class="docutils literal notranslate"><span class="pre">pw_rpc</span></code> module does not handle the transmission of
RPCs. This module enables the transmission of RPCs and other bytes through a
serial connection.</p>
<p>There are essentially two main functions of the <code class="docutils literal notranslate"><span class="pre">pw_hdlc_lite</span></code> module:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>Encoding</strong> the data by escaping the bytes of the payload, calculating the
CCITT-CRC16 value, constructing a data frame and sending the
resulting data packet through serial.</p></li>
<li><p><strong>Decoding</strong> the data by unescaping the received bytes, verifying the
CCITT-CRC16 value and returning the successfully decoded packets.</p></li>
</ul>
</div></blockquote>
<p><strong>Why use the ``pw_hdlc_lite`` module?</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>Enables the transmission of RPCs and other data between devices over serial</p></li>
<li><p>Resilient to corruption and data loss.</p></li>
<li><p>Light-weight, simple and easy to use.</p></li>
<li><p>Supports streaming to transport without buffering - e.g. protocol buffers
have length-prefix.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="protocol-description">
<h2>Protocol Description<a class="headerlink" href="#protocol-description" title="Permalink to this headline">¶</a></h2>
<div class="section" id="encoding-and-sending-data">
<h3>Encoding and sending data<a class="headerlink" href="#encoding-and-sending-data" title="Permalink to this headline">¶</a></h3>
<p>This module first writes an initial frame delimiter byte (0x7E) to indicate the
beginning of the frame. Before sending any of the payload data through serial,
the special bytes are escaped accordingly:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 51%" />
<col style="width: 49%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Unescaped Special Bytes</p></th>
<th class="head"><p>Escaped Special Bytes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x7E</p></td>
<td><p>0x7D5E</p></td>
</tr>
<tr class="row-odd"><td><p>0x7D</p></td>
<td><p>0x7D5D</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The bytes of the payload are escaped and written in a single pass. The
CCITT-CRC16 value is calculated, escaped and written after. After this, a final
frame delimiter byte (0x7E) is written to mark the end of the frame.</p>
</div>
<div class="section" id="decoding-received-bytes">
<h3>Decoding received bytes<a class="headerlink" href="#decoding-received-bytes" title="Permalink to this headline">¶</a></h3>
<p>Packets may be received in multiple parts, so we need to store the received data
in a buffer until the ending frame delimiter (0x7E) is read. When the
pw_hdlc_lite decoder receives data, it unescapes it and adds it to a buffer.
When the frame is complete, it calculates and verifies the CCITT-CRC16 bytes and
does the following:</p>
<ul class="simple">
<li><p>If correctly verified, the decoder returns the decoded packet.</p></li>
<li><p>If the checksum verification fails, the data packet is discarded.</p></li>
</ul>
<p>During the decoding process, the decoder essentially transitions between 3
states, where each state indicates the method of decoding that particular byte:</p>
<p>NO_PACKET –&gt; PACKET_ACTIVE –&gt; (ESCAPE | NO_PACKET).</p>
</div>
</div>
<div class="section" id="api-usage">
<h2>API Usage<a class="headerlink" href="#api-usage" title="Permalink to this headline">¶</a></h2>
<div class="section" id="encoder">
<h3>Encoder<a class="headerlink" href="#encoder" title="Permalink to this headline">¶</a></h3>
<p>The Encoder API invloves a single function that encodes the data using the
HDLC-Lite protocol and sends the data through the serial.</p>
<div class="section" id="c">
<h4>C++<a class="headerlink" href="#c" title="Permalink to this headline">¶</a></h4>
<p>In C++, this function is called <code class="docutils literal notranslate"><span class="pre">EncodeAndWritePayload</span></code> and it accepts a
ConstByteSpan called payload and an object of type Writer&amp; as arguments. It
returns a Status object that indicates if the write was successful. This
implementation uses the <code class="docutils literal notranslate"><span class="pre">pw_checksum</span></code> module to compute the CRC16 value. Since
the function writes a starting and ending frame delimiter byte at the beginnning
and the end of frames, it is safe to encode multiple spans. The usage of this
function is as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;pw_hdlc_lite/encoder.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;pw_hdlc_lite/sys_io_stream.h&quot;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">pw</span><span class="o">::</span><span class="n">stream</span><span class="o">::</span><span class="n">SerialWriter</span> <span class="n">serial_writer</span><span class="p">;</span>
    <span class="k">constexpr</span> <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">byte</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">test_array</span> <span class="o">=</span> <span class="p">{</span> <span class="n">byte</span><span class="p">(</span><span class="mh">0x41</span><span class="p">)</span> <span class="p">};</span>
    <span class="k">auto</span> <span class="n">status</span> <span class="o">=</span> <span class="n">EncodeAndWritePayload</span><span class="p">(</span><span class="n">test_array</span><span class="p">,</span> <span class="n">serial_writer</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the example above, we expect the encoder to send the following bytes:</p>
<ul class="simple">
<li><p><strong>0x7E</strong> - Initial Frame Delimiter</p></li>
<li><p><strong>0x41</strong> - Payload</p></li>
<li><p><strong>0x15</strong> - LSB of the CCITT-CRC16 value</p></li>
<li><p><strong>0xB9</strong> - MSB of the CCITT-CRC16 value</p></li>
<li><p><strong>0x7E</strong> - End Frame Delimiter</p></li>
</ul>
</div>
<div class="section" id="python">
<h4>Python<a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h4>
<p>In Python, the function is called <code class="docutils literal notranslate"><span class="pre">encode_and_write_payload</span></code> and it accepts
the payload as a byte object and a callable to which is used to write the data.
This function does not return anything, and uses the binascii library function
called crc_hqx to compute the CRC16 bytes. Like the C++ function, the Python
function also writes a frame delimiter at the beginnning and the end of frames
so it is safe to encode multiple spans consecutively. The usage of this function
is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">serial</span>
<span class="kn">from</span> <span class="nn">pw_hdlc_lite</span> <span class="kn">import</span> <span class="n">encoder</span>

<span class="n">ser</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">()</span>
<span class="n">encoder</span><span class="o">.</span><span class="n">encode_and_write_payload</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">)</span>
</pre></div>
</div>
<p>We expect this example to give us the same result as the C++ example above since
it encodes the same payload.</p>
</div>
</div>
<div class="section" id="decoder">
<h3>Decoder<a class="headerlink" href="#decoder" title="Permalink to this headline">¶</a></h3>
<p>The Decoder API involves a Decoder class whose main functionality is a function
that unescapes the received bytes, adds them to a buffer and returns the
successfully decoded packets. A class is used so that the user can call the
decoder object’s adding bytes functionality on the currently received bytes
instead of waiting on the entire packet to arrive.</p>
<div class="section" id="id1">
<h4>C++<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>The main functionality of the C++ <code class="docutils literal notranslate"><span class="pre">Decoder</span></code> class is the ‘AddByte’ function
which accepts a single byte as an argument, unescapes it and adds it to the
buffer. If the byte is the ending frame delimiter flag (0x7E) it attempts to
decode the packet and returns a <code class="docutils literal notranslate"><span class="pre">Result</span></code> object indicating the success of the
operation:</p>
<blockquote>
<div><ul class="simple">
<li><p>The returned <code class="docutils literal notranslate"><span class="pre">pw::Result</span></code> object will have status <code class="docutils literal notranslate"><span class="pre">Status::OK</span></code> and
value ConstByteSpan containing the most recently decoded packet if it finds
the end of the data-frame and successfully verifies the CRC.</p></li>
<li><p>The returned <code class="docutils literal notranslate"><span class="pre">pw::Result</span></code> object will have status <code class="docutils literal notranslate"><span class="pre">Status::UNAVAILABLE</span></code>
if it doesnt find the end of the data-frame during that function call.</p></li>
<li><p>The returned <code class="docutils literal notranslate"><span class="pre">pw::Result</span></code> object will have status <code class="docutils literal notranslate"><span class="pre">Status::DATA_LOSS</span></code>
if it finds the end of the data-frame, but the CRC-verification fails. It
also returns this status if the packet in question does not have the
2-byte CRC in it.</p></li>
<li><p>The returned <code class="docutils literal notranslate"><span class="pre">pw::Result</span></code> object will have status
<code class="docutils literal notranslate"><span class="pre">Status::RESOURCE_EXHAUSTED</span></code> if the decoder buffer runs out of space.</p></li>
</ul>
</div></blockquote>
<p>Here’s a C++ example of reading individual bytes from serial and then using the
decoder object to decode the received data:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;pw_hdlc_lite/decoder.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;pw_sys_io/sys_io.h&quot;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">byte</span> <span class="n">data</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pw</span><span class="o">::</span><span class="n">sys_io</span><span class="o">::</span><span class="n">ReadByte</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">).</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
      <span class="c1">// Log serial reading error</span>
    <span class="p">}</span>
    <span class="k">auto</span> <span class="n">decoded_packet</span> <span class="o">=</span> <span class="n">decoder</span><span class="p">.</span><span class="n">AddByte</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">decoded_packet</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
     <span class="c1">// Use decoded_packet to get access to the most recently decoded packet</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h4>Python<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>The main functionality of the Python <code class="docutils literal notranslate"><span class="pre">Decoder</span></code> class is the <code class="docutils literal notranslate"><span class="pre">add_bytes</span></code>
generator which unescapes the bytes object argument and adds them to a buffer
until it encounters the ending frame delimiter (0x7E) flag. The generator yields
the decoded packets as byte objects upon successfully verification of the CRC16
value of the received bytes. If the CRC verification fails it raises a
CrcMismatchError exception.</p>
<p>Below is an example of the usage of the decoder class to decode bytes read from
serial:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">serial</span>
<span class="kn">from</span> <span class="nn">pw_hdlc_lite</span> <span class="kn">import</span> <span class="n">decoder</span>

<span class="n">ser</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">()</span>
<span class="n">decode</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">Decoder</span><span class="p">()</span>

<span class="k">while</span> <span class="n">true</span><span class="p">:</span>
  <span class="n">byte</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">decoded_packet</span> <span class="ow">in</span> <span class="n">decode</span><span class="o">.</span><span class="n">add_bytes</span><span class="p">(</span><span class="n">byte</span><span class="p">):</span>
    <span class="c1"># Do something with the decoded packet</span>
</pre></div>
</div>
<p>Like the C++ example, this reads individual bytes and adds them to the decoder.</p>
</div>
</div>
</div>
<div class="section" id="features">
<h2>Features<a class="headerlink" href="#features" title="Permalink to this headline">¶</a></h2>
<div class="section" id="pw-stream-serialwriter">
<h3>pw::stream::SerialWriter<a class="headerlink" href="#pw-stream-serialwriter" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">SerialWriter</span></code> class implements the <code class="docutils literal notranslate"><span class="pre">Writer</span></code> interface by using sys_io
to write data over a serial connection. This Writer object is used by the C++
encoder to send the encoded bytes to the device.</p>
</div>
</div>
<div class="section" id="roadmap-status">
<h2>Roadmap &amp; Status<a class="headerlink" href="#roadmap-status" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><strong>Additional fields</strong> - As it currently stands, <code class="docutils literal notranslate"><span class="pre">pw_hdlc_lite</span></code> uses only
three fields of control bytes: starting frame delimiter, 2-byte CRC and an
ending frame delimiter. However, if we decided to send larger, more
complicated RPCs and if wanted to stream log debug and error messages, we will
require additional fields of data to ensure the different packets are sent
correctly. Thus, in the future, we plan to add additional channel and sequence
byte fields that could enable separate channels for pw_rpc, QoS etc.</p></li>
<li><p><strong>Higher performance</strong> - We plan to improve the overall performance of the
decoder and encoder implementations by using SIMD/NEON.</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../pw_hex_dump/docs.html" class="btn btn-neutral float-right" title="pw_hex_dump" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../pw_fuzzer/docs.html" class="btn btn-neutral float-left" title="pw_fuzzer" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020 The Pigweed Authors

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
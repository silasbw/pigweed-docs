

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pw_stream &mdash; Pigweed</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="pw_string" href="../pw_string/docs.html" />
    <link rel="prev" title="pw_status" href="../pw_status/docs.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Pigweed
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pigweed.googlesource.com/pigweed/pigweed/+/refs/heads/master">Source Code</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pigweed-review.googlesource.com">Code Reviews</a></li>
<li class="toctree-l1"><a class="reference external" href="https://groups.google.com/forum/#!forum/pigweed">Mailing List</a></li>
<li class="toctree-l1"><a class="reference external" href="https://discord.gg/M9NSeTA">Chat Room</a></li>
<li class="toctree-l1"><a class="reference external" href="https://bugs.chromium.org/p/pigweed/issues/list">Issue Tracker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CODE_OF_CONDUCT.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/embedded_cpp_guide.html">Embedded C++ Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/style_guide.html">Code Style</a></li>
<li class="toctree-l1"><a class="reference internal" href="../targets.html">Targets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build_system.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/module_structure.html">Module Structure</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../module_guides.html">Module Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../docker/docs.html">docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_allocator/docs.html">pw_allocator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_assert/docs.html">pw_assert</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_assert_basic/docs.html">pw_assert_basic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_assert_log/docs.html">pw_assert_log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_base64/docs.html">pw_base64</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_bloat/docs.html">pw_bloat</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_blob_store/docs.html">pw_blob_store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_boot_armv7m/docs.html">pw_boot_armv7m</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_build/docs.html">pw_build</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_bytes/docs.html">pw_bytes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_checksum/docs.html">pw_checksum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_cli/docs.html">pw_cli</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_containers/docs.html">pw_containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_cpu_exception/docs.html">pw_cpu_exception</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_cpu_exception_armv7m/docs.html">pw_cpu_exception_armv7m</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_docgen/docs.html">pw_docgen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_doctor/docs.html">pw_doctor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_env_setup/docs.html">pw_env_setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_fuzzer/docs.html">pw_fuzzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_hdlc_lite/docs.html">pw_hdlc_lite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_hex_dump/docs.html">pw_hex_dump</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_kvs/docs.html">pw_kvs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_log/docs.html">pw_log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_log_basic/docs.html">pw_log_basic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_log_null/docs.html">pw_log_null</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_log_tokenized/docs.html">pw_log_tokenized</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_metric/docs.html">pw_metric</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_minimal_cpp_stdlib/docs.html">pw_minimal_cpp_stdlib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_module/docs.html">pw_module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_polyfill/docs.html">pw_polyfill</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_preprocessor/docs.html">pw_preprocessor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_presubmit/docs.html">pw_presubmit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_protobuf/docs.html">pw_protobuf</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_protobuf_compiler/docs.html">pw_protobuf_compiler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_random/docs.html">pw_random</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_result/docs.html">pw_result</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_ring_buffer/docs.html">pw_ring_buffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_rpc/docs.html">pw_rpc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_span/docs.html">pw_span</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_status/docs.html">pw_status</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">pw_stream</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pw-stream-writer">pw::stream::Writer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pw-stream-reader">pw::stream::Reader</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pw-stream-memorywriter">pw::stream::MemoryWriter</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pw-stream-memoryreader">pw::stream::MemoryReader</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#why-use-pw-stream">Why use pw_stream?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#standard-api">Standard API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reduce-intermediate-buffers">Reduce intermediate buffers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#prevent-buffer-overflow">Prevent buffer overflow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#why-not-pw-stream">Why NOT pw_stream?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dependencies">Dependencies</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../pw_string/docs.html">pw_string</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_sys_io/docs.html">pw_sys_io</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_sys_io_baremetal_stm32f429/docs.html">pw_sys_io_baremetal_stm32f429</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_sys_io_stdio/docs.html">pw_sys_io_stdio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_target_runner/docs.html">pw_target_runner</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_tokenizer/docs.html">pw_tokenizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_toolchain/docs.html">pw_toolchain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_trace/docs.html">pw_trace</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_trace_tokenized/docs.html">pw_trace_tokenized</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_unit_test/docs.html">pw_unit_test</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_varint/docs.html">pw_varint</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_watch/docs.html">pw_watch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pw_web_ui/docs.html">pw_web_ui</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Pigweed</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../module_guides.html">Module Guides</a> &raquo;</li>
        
      <li>pw_stream</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="pw-stream">
<h1>pw_stream<a class="headerlink" href="#pw-stream" title="Permalink to this headline">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">pw_stream</span></code> provides a foundational interface for streaming data from one part
of a system to another. In the simplest use cases, this is basically a memcpy
behind a reusable interface that can be passed around the system. On the other
hand, the flexibility of this interface means a <code class="docutils literal notranslate"><span class="pre">pw_stream</span></code> could terminate is
something more complex, like a UART stream or flash memory.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>At the most basic level, <code class="docutils literal notranslate"><span class="pre">pw_stream</span></code>’s interfaces provide very simple handles
to enabling streaming data from one location in a system to an endpoint.</p>
<p>Example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">DumpSensorData</span><span class="p">(</span><span class="n">pw</span><span class="o">::</span><span class="n">stream</span><span class="o">::</span><span class="n">Writer</span><span class="o">&amp;</span> <span class="n">writer</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">static</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
  <span class="n">ImuSample</span> <span class="n">imu_sample</span><span class="p">;</span>
  <span class="n">imu</span><span class="p">.</span><span class="n">GetSample</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">bytes_written</span> <span class="o">=</span> <span class="n">imu_sample</span><span class="p">.</span><span class="n">AsCsv</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">temp</span><span class="p">));</span>
  <span class="n">writer</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">bytes_written</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In this example, <code class="docutils literal notranslate"><span class="pre">DumpSensorData()</span></code> only cares that it has access to a
<code class="docutils literal notranslate"><span class="pre">Writer</span></code> that it can use to stream data to using <code class="docutils literal notranslate"><span class="pre">Writer::Write()</span></code>. The
<code class="docutils literal notranslate"><span class="pre">Writer</span></code> itself can be backed by anything that can act as a data “sink.”</p>
<div class="section" id="pw-stream-writer">
<h3>pw::stream::Writer<a class="headerlink" href="#pw-stream-writer" title="Permalink to this headline">¶</a></h3>
<p>This is the foundational stream <code class="docutils literal notranslate"><span class="pre">Writer</span></code> abstract class. Any class that wishes
to implement the <code class="docutils literal notranslate"><span class="pre">Writer</span></code> interface <strong>must</strong> provide a <code class="docutils literal notranslate"><span class="pre">DoWrite()</span></code>
implementation. Note that <code class="docutils literal notranslate"><span class="pre">Write()</span></code> itself is <strong>not</strong> virtual, and should not
be overridden.</p>
<div class="section" id="buffering">
<h4>Buffering<a class="headerlink" href="#buffering" title="Permalink to this headline">¶</a></h4>
<p>If any buffering occurs in a <code class="docutils literal notranslate"><span class="pre">Writer</span></code> and data must be flushed before it is
fully committed to the sink, a <code class="docutils literal notranslate"><span class="pre">Writer</span></code> implementation is resposible for any
<code class="docutils literal notranslate"><span class="pre">Flush()</span></code> capability.</p>
</div>
</div>
<div class="section" id="pw-stream-reader">
<h3>pw::stream::Reader<a class="headerlink" href="#pw-stream-reader" title="Permalink to this headline">¶</a></h3>
<p>This is the foundational stream <code class="docutils literal notranslate"><span class="pre">Reader</span></code> abstract class. Any class that wishes
to implement the <code class="docutils literal notranslate"><span class="pre">Reader</span></code> interface <strong>must</strong> provide a <code class="docutils literal notranslate"><span class="pre">DoRead()</span></code>
implementation. Note that <code class="docutils literal notranslate"><span class="pre">Read()</span></code> itself is <strong>not</strong> virtual, and should not
be overridden.</p>
</div>
<div class="section" id="pw-stream-memorywriter">
<h3>pw::stream::MemoryWriter<a class="headerlink" href="#pw-stream-memorywriter" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">MemoryWriter</span></code> class implements the <code class="docutils literal notranslate"><span class="pre">Writer</span></code> interface by backing the
data destination with an <strong>externally-provided</strong> memory buffer.
<code class="docutils literal notranslate"><span class="pre">MemoryWriterBuffer</span></code> extends <code class="docutils literal notranslate"><span class="pre">MemoryWriter</span></code> to internally provide a memory
buffer.</p>
</div>
<div class="section" id="pw-stream-memoryreader">
<h3>pw::stream::MemoryReader<a class="headerlink" href="#pw-stream-memoryreader" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">MemoryReader</span></code> class implements the <code class="docutils literal notranslate"><span class="pre">Reader</span></code> interface by backing the
data source with an <strong>externally-provided</strong> memory buffer.</p>
</div>
</div>
<div class="section" id="why-use-pw-stream">
<h2>Why use pw_stream?<a class="headerlink" href="#why-use-pw-stream" title="Permalink to this headline">¶</a></h2>
<div class="section" id="standard-api">
<h3>Standard API<a class="headerlink" href="#standard-api" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">pw_stream</span></code> provides a standard way for classes to express that they have the
ability to write data. Writing to one sink versus another sink is a matter of
just passing a reference to the appropriate <code class="docutils literal notranslate"><span class="pre">Writer</span></code>.</p>
<p>As an example, imagine dumping sensor data. If written against a random HAL
or one-off class, there’s porting work required to write to a different sink
(imagine writing over UART vs dumping to flash memory). Building a “dumping”
implementation against the <code class="docutils literal notranslate"><span class="pre">Writer</span></code> interface prevents a dependency from
forming on an artisainal API that would require porting work.</p>
<p>Similarly, after building a <code class="docutils literal notranslate"><span class="pre">Writer</span></code> implementation for a Sink that data
could be dumped to, that same <code class="docutils literal notranslate"><span class="pre">Writer</span></code> can be reused for other contexts that
already write data to the <code class="docutils literal notranslate"><span class="pre">pw::stream::Writer</span></code> interface.</p>
<p>Before:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Not reusable, depends on `Uart`.</span>
<span class="kt">void</span> <span class="nf">DumpSensorData</span><span class="p">(</span><span class="n">Uart</span><span class="o">&amp;</span> <span class="n">uart</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">static</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
  <span class="n">ImuSample</span> <span class="n">imu_sample</span><span class="p">;</span>
  <span class="n">imu</span><span class="p">.</span><span class="n">GetSample</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">bytes_written</span> <span class="o">=</span> <span class="n">imu_sample</span><span class="p">.</span><span class="n">AsCsv</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">temp</span><span class="p">));</span>
  <span class="n">uart</span><span class="p">.</span><span class="n">Transmit</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">bytes_written</span><span class="p">,</span> <span class="cm">/*timeout_ms=*/</span> <span class="mi">200</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>After:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Reusable; no more Uart dependency!</span>
<span class="kt">void</span> <span class="nf">DumpSensorData</span><span class="p">(</span><span class="n">Writer</span><span class="o">&amp;</span> <span class="n">writer</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">static</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
  <span class="n">ImuSample</span> <span class="n">imu_sample</span><span class="p">;</span>
  <span class="n">imu</span><span class="p">.</span><span class="n">GetSample</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">bytes_written</span> <span class="o">=</span> <span class="n">imu_sample</span><span class="p">.</span><span class="n">AsCsv</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">temp</span><span class="p">));</span>
  <span class="n">writer</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">bytes_written</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="reduce-intermediate-buffers">
<h3>Reduce intermediate buffers<a class="headerlink" href="#reduce-intermediate-buffers" title="Permalink to this headline">¶</a></h3>
<p>Often functions that write larger blobs of data request a buffer is passed as
the destination that data should be written to. This <em>requires</em> a buffer is
allocated, even if the data only exists in that buffer for a very short period
of time before it’s  written somewhere else.</p>
<p>In situations where data read from somewhere will immediately be written
somewhere else, a <code class="docutils literal notranslate"><span class="pre">Writer</span></code> interface can cut out the middleman buffer.</p>
<p>Before:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Requires an intermediate buffer to write the data as CSV.</span>
<span class="kt">void</span> <span class="nf">DumpSensorData</span><span class="p">(</span><span class="n">Uart</span><span class="o">*</span> <span class="n">uart</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">temp</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
  <span class="n">ImuSample</span> <span class="n">imu_sample</span><span class="p">;</span>
  <span class="n">imu</span><span class="p">.</span><span class="n">GetSample</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">bytes_written</span> <span class="o">=</span> <span class="n">imu_sample</span><span class="p">.</span><span class="n">AsCsv</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">temp</span><span class="p">));</span>
  <span class="n">uart</span><span class="p">.</span><span class="n">Transmit</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">bytes_written</span><span class="p">,</span> <span class="cm">/*timeout_ms=*/</span> <span class="mi">200</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>After:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Both DumpSensorData() and RawSample::AsCsv() use a Writer, eliminating the</span>
<span class="c1">// need for an intermediate buffer.</span>
<span class="kt">void</span> <span class="nf">DumpSensorData</span><span class="p">(</span><span class="n">Writer</span><span class="o">*</span> <span class="n">writer</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">RawSample</span> <span class="n">imu_sample</span><span class="p">;</span>
  <span class="n">imu</span><span class="p">.</span><span class="n">GetSample</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
  <span class="n">imu_sample</span><span class="p">.</span><span class="n">AsCsv</span><span class="p">(</span><span class="n">writer</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="prevent-buffer-overflow">
<h3>Prevent buffer overflow<a class="headerlink" href="#prevent-buffer-overflow" title="Permalink to this headline">¶</a></h3>
<p>When copying data from one buffer to another, there must be checks to ensure the
copy does not overflow the destination buffer. As this sort of logic is
duplicated throughout a codebase, there’s more opportunities for bound-checking
bugs to sneak in. <code class="docutils literal notranslate"><span class="pre">Writers</span></code> manage this logic internally rather than pushing
the bounds checking to the code that is moving or writing the data.</p>
<p>Similarly, since only the <code class="docutils literal notranslate"><span class="pre">Writer</span></code> has access to any underlying buffers, it’s
harder for functions that share a <code class="docutils literal notranslate"><span class="pre">Writer</span></code> to accidentally clobber data
written by others using the same buffer.</p>
<p>Before:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Status</span> <span class="nf">BuildPacket</span><span class="p">(</span><span class="n">Id</span> <span class="n">dest</span><span class="p">,</span> <span class="n">span</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">byte</span><span class="o">&gt;</span> <span class="n">payload</span><span class="p">,</span>
                   <span class="n">span</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">byte</span><span class="o">&gt;</span> <span class="n">dest</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Header</span> <span class="n">header</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dest</span><span class="p">.</span><span class="n">size_bytes</span><span class="p">()</span> <span class="o">+</span> <span class="n">payload</span><span class="p">.</span><span class="n">size_bytes</span><span class="p">()</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Header</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Status</span><span class="o">::</span><span class="n">RESOURCE_EXHAUSTED</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">header</span><span class="p">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>
  <span class="n">header</span><span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">DeviceId</span><span class="p">();</span>
  <span class="n">header</span><span class="p">.</span><span class="n">payload_size</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="n">size_bytes</span><span class="p">();</span>

  <span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">header</span><span class="p">));</span>
  <span class="c1">// Forgetting this line would clobber buffer contents. Also, using</span>
  <span class="c1">// a temporary span instead could leave `dest` to be misused elsewhere in</span>
  <span class="c1">// the function.</span>
  <span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span><span class="p">.</span><span class="n">subspan</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">header</span><span class="p">));</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">payload</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">payload</span><span class="p">.</span><span class="n">size_bytes</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>After:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Status</span> <span class="nf">BuildPacket</span><span class="p">(</span><span class="n">Id</span> <span class="n">dest</span><span class="p">,</span> <span class="n">span</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">byte</span><span class="o">&gt;</span> <span class="n">payload</span><span class="p">,</span> <span class="n">Writer</span><span class="o">&amp;</span> <span class="n">writer</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Header</span> <span class="n">header</span><span class="p">;</span>
  <span class="n">header</span><span class="p">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>
  <span class="n">header</span><span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">DeviceId</span><span class="p">();</span>
  <span class="n">header</span><span class="p">.</span><span class="n">payload_size</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="n">size_bytes</span><span class="p">();</span>

  <span class="n">writer</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">writer</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="why-not-pw-stream">
<h2>Why NOT pw_stream?<a class="headerlink" href="#why-not-pw-stream" title="Permalink to this headline">¶</a></h2>
<p>pw_stream provides a virtual interface. This inherently has more overhead than
a regular function call. In extremely performance-sensitive contexts, a virtual
interface might not provide enough utility to justify the performance cost.</p>
</div>
<div class="section" id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pw_assert</span></code> module</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pw_preprocessor</span></code> module</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pw_status</span></code> module</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pw_span</span></code> module</p></li>
</ul>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../pw_string/docs.html" class="btn btn-neutral float-right" title="pw_string" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../pw_status/docs.html" class="btn btn-neutral float-left" title="pw_status" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020 The Pigweed Authors

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>